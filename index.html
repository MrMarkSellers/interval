<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Interval Trainer — iOS Styled</title>
<style>
    :root {
        --bg: #f2f2f7;
        --panel: #ffffff;
        --radius: 18px;
        --accent: #007aff;
        --danger: #ff3b30;
        --text-dark: #1c1c1e;
    }
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); margin: 0; padding: 16px; color: var(--text-dark); }
    h1 { text-align: center; font-weight: 700; }
    .panel { background: var(--panel); border-radius: var(--radius); padding: 16px; margin-bottom: 16px; box-shadow: 0 2px 6px rgba(0,0,0,0.06); }
    button { padding: 12px 18px; border: none; border-radius: 12px; font-size: 16px; }
    .primary { background: var(--accent); color: white; }
    .danger { background: var(--danger); color: white; }
    input, select { padding: 12px; font-size: 16px; border-radius: 12px; border: 1px solid #ccc; width: 100%; box-sizing: border-box; }
    #timeline .item { padding: 12px; background: #f8f8f8; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
    .drag { cursor: grab; font-size: 20px; margin-left: 10px; }

    /* Radial countdown */
    #radial { width: 160px; height: 160px; margin: 20px auto; position: relative; }
    #radial svg { transform: rotate(-90deg); }
    #radial circle { fill: none; stroke-width: 14; stroke-linecap: round; }
    #radial .bg { stroke: #ddd; }
    #radial .progress { stroke: var(--accent); transition: stroke-dashoffset 1s linear; }
    #radial .time { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 32px; font-weight: bold; }

    /* Media fit */
    #mediaDisplay img, #mediaDisplay video { max-width: 100%; max-height: 70vh; display: block; margin: 0 auto; border-radius: 12px; }
</style>
</head>
<body>
<h1>Interval Trainer</h1>

<div class="panel">
    <label>Duration per Interval</label><br>
    <select id="duration">
        <option value="30">30 sec</option>
        <option value="45">45 sec</option>
        <option value="60">60 sec</option>
    </select><br><br>

    <label>Repetitions</label>
    <input id="reps" type="number" min="1" max="10" value="1" />
</div>

<div class="panel">
    <h2>Media Items</h2>
    <input type="file" id="fileInput" accept="image/*,video/*"><br><br>
    <button class="primary" onclick="addMedia()">Add Media</button>

    <h3>Timeline</h3>
    <div id="timeline"></div>
</div>

<div class="panel">
    <h2>Save Sequence</h2>
    <input id="seqName" placeholder="Sequence Name"><br><br>
    <button class="primary" onclick="saveSequence()">Save Sequence</button>

    <h3>Saved</h3>
    <div id="sequenceList"></div>
</div>

<div id="playback" class="panel" style="display:none; text-align:center;">
    <h2 id="playbackTitle"></h2>
    <div id="repInfo"></div>

    <div id="radial">
        <svg width="160" height="160">
            <circle class="bg" cx="80" cy="80" r="70"></circle>
            <circle class="progress" cx="80" cy="80" r="70"></circle>
        </svg>
        <div class="time" id="timeText"></div>
    </div>

    <div id="mediaDisplay"></div>

    <br>
    <button class="danger" onclick="stopPlayback()">Stop</button>
</div>

<script>
// ===== IndexedDB =====
let db;
const request = indexedDB.open("IntervalTrainerDB", 1);
request.onupgradeneeded = e => {
    db = e.target.result;
    if (!db.objectStoreNames.contains("media")) db.createObjectStore("media", { keyPath: "id" });
};
request.onsuccess = e => { db = e.target.result; loadSequences(); };

// ===== State =====
let items = [];
let sequences = JSON.parse(localStorage.getItem("sequences") || "[]");
let timer, currentIndex, timeLeft, currentSequence;
let dragIndex = null;

// ===== Helpers =====
const uuid = () => "xxxx-xxxx".replace(/[x]/g,()=> (Math.random()*16|0).toString(16));

function saveMediaToDB(id, file) {
    db.transaction(["media"],"readwrite").objectStore("media").put({ id, blob:file, name:file.name, type:file.type });
}
function getMedia(id) {
    return new Promise(res=>{
        let r=db.transaction(["media"],"readonly").objectStore("media").get(id);
        r.onsuccess=()=>res(r.result);
    });
}

// ===== Media Add =====
async function addMedia() {
    const reps = parseInt(reps.value);
    if (items.length >= reps) return alert(`Max ${reps} items allowed.`);

    const file = fileInput.files[0];
    if (!file) return alert("Select a file");

    const id = uuid();
    saveMediaToDB(id, file);
    items.push({ id, name:file.name, type:file.type.startsWith("video")?"video":"photo" });
    renderTimeline();
}

// ===== Timeline =====
function renderTimeline() {
    timeline.innerHTML = items.map((m,i)=>`
        <div class='item' draggable='true' ondragstart='dragIndex=${i}' ondragover='event.preventDefault()' ondrop='dropItem(${i})'>
            <span>${i+1}. Stage ${i+1} — ${m.name}</span>
            <div>
                <button class='danger' onclick='deleteItem(${i})'>Delete</button>
                <span class='drag'>☰</span>
            </div>
        </div>`).join('');
}
function dropItem(i){ const x=items.splice(dragIndex,1)[0]; items.splice(i,0,x); renderTimeline(); }
function deleteItem(i){ items.splice(i,1); renderTimeline(); }

// ===== Save / Load =====
function saveSequence() {
    if (items.length != parseInt(reps.value)) return alert("Media must match repetitions");
    sequences.push({ name: seqName.value, duration: parseInt(duration.value), items:[...items] });
    localStorage.setItem("sequences", JSON.stringify(sequences));
    loadSequences();
}
function deleteSequence(i){ sequences.splice(i,1); localStorage.setItem("sequences",JSON.stringify(sequences)); loadSequences(); }
function loadSequences(){ sequenceList.innerHTML = sequences.map((s,i)=>`
    <div style='margin:10px 0;'>
        <button class='primary' onclick='startSequence(${i})'>${s.name}</button>
        <button class='danger' onclick='deleteSequence(${i})'>Delete</button>
    </div>`).join(''); }

// ===== Playback =====
function setRadialProgress(percent) {
    const circle = document.querySelector('.progress');
    const radius = 70;
    const circumference = 2 * Math.PI * radius;
    circle.style.strokeDasharray = `${circumference}`;
    circle.style.strokeDashoffset = `${circumference - percent * circumference}`;
}

async function startSequence(i){
    currentSequence = sequences[i];
    playback.style.display='block';
    items = [...currentSequence.items];
    currentIndex = 0;
    timeLeft = currentSequence.duration;
    updateInfo();
    playMedia(items[currentIndex]);
    timer = setInterval(tick,1000);
}

function updateInfo(){
    playbackTitle.textContent = currentSequence.name;
    repInfo.textContent = `${currentIndex+1} of ${items.length}`;
}

async function tick(){
    timeText.textContent = timeLeft + "s";
    setRadialProgress(timeLeft / currentSequence.duration);

    if (timeLeft <= 0){
        currentIndex++;
        if (currentIndex >= items.length){ stopPlayback(); alert("Done!"); return; }
        timeLeft = currentSequence.duration;
        playMedia(items[currentIndex]);
        updateInfo();
    }
    timeLeft--;
}

async function playMedia(item){
    const record = await getMedia(item.id);
    const url = URL.createObjectURL(record.blob);
    mediaDisplay.innerHTML = item.type === "video" ? `<video src='${url}' autoplay loop></video>` : `<img src='${url}'>`;
}

function stopPlayback(){ clearInterval(timer); playback.style.display='none'; }
</script>
</body>
</html>
